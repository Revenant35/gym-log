<ion-card class="exercise-card" [class.completed]="isCompleted()">
  <ion-card-header (click)="toggleExpand()">
    <div class="exercise-header">
      <div class="exercise-info">
        <div class="exercise-title-row">
          <h3 class="exercise-name">{{ log().exercise.name }}</h3>
          @if (isCompleted()) {
            <ion-icon name="checkmark-circle" color="success"></ion-icon>
          }
        </div>
        <p class="exercise-target">
          {{ log().exercise.sets }} Ã— {{ log().exercise.reps }} &#64; {{ log().exercise.weight }} {{ log().exercise.weight_unit }}
        </p>
        <div class="set-progress">
          <ion-progress-bar [value]="progress()" [color]="progressColor()" />
          <span class="progress-text">
            {{ completedSets() }}/{{ totalSets() }} sets
          </span>
        </div>
      </div>
      <ion-icon
        [name]="isExpanded() ? 'chevron-up-outline' : 'chevron-down-outline'"
        class="expand-icon"
      ></ion-icon>
    </div>
  </ion-card-header>

  @if (isExpanded()) {
    <ion-card-content>
      <div class="sets-list">
        @for (set of log().sets; track setIdx; let setIdx = $index) {
          <div class="set-row" [class.completed]="set.completed">
            <div class="set-number">{{ setIdx + 1 }}</div>

            <div class="set-inputs">
              <div class="input-group">
                <label>Reps</label>
                <ion-input
                  type="number"
                  [value]="set.reps"
                  (ionInput)="updateSetReps(setIdx, +$event.detail.value!)"
                  [disabled]="set.completed"
                ></ion-input>
              </div>

              @if (log().exercise.weight > 0) {
                <div class="input-group">
                  <label>Weight</label>
                  <div class="weight-input">
                    <ion-input
                      type="number"
                      [value]="set.weight"
                      (ionInput)="updateSetWeight(setIdx, +$event.detail.value!)"
                      [disabled]="set.completed"
                    ></ion-input>
                    <span class="unit">{{ log().exercise.weight_unit }}</span>
                  </div>
                </div>
              }
            </div>

            <div class="set-actions">
              @if (!set.completed) {
                <ion-button
                  fill="solid"
                  color="primary"
                  size="small"
                  (click)="completeSet(setIdx)"
                >
                  <ion-icon slot="icon-only" name="checkmark-outline"></ion-icon>
                </ion-button>
              } @else {
                <ion-button
                  fill="outline"
                  color="success"
                  size="small"
                  (click)="uncompleteSet(setIdx)"
                >
                  <ion-icon slot="icon-only" name="checkmark-outline"></ion-icon>
                </ion-button>
              }

              @if (log().sets.length > 1) {
                <ion-button
                  fill="clear"
                  color="danger"
                  size="small"
                  (click)="removeSet(setIdx)"
                >
                  <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
                </ion-button>
              }
            </div>
          </div>
        }
      </div>

      <ion-button
        expand="block"
        fill="outline"
        size="small"
        (click)="addSet()"
        class="add-set-button">
        <ion-icon slot="start" name="add-outline"></ion-icon>
        Add Set
      </ion-button>
    </ion-card-content>
  }
</ion-card>
